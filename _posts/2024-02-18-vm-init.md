---
layout: post
title: Quick Virtualbox
tags:
  - code
---

khởi tạo và các thao tác nhanh với server

# Preinstall 

cài đặt virtualbox để sử dụng máy ảo
```
sudo apt install virtualbox virtualbox-ext-pack
```

cài vagrant để  khởi tạo máy ảo tự động từ file
```
sudo apt-get install vagrant
vagrant version
vagrant up
vagrant destroy
```

# Vagrant file

<details markdown="1">
<summary>tạo 2 máy ảo với địa chỉ cố định, add user và cập quyền ssh từ host</summary>

```
VAGRANT_COMMAND = ARGV[0]

Vagrant.configure("2") do |config|

    if VAGRANT_COMMAND == "ssh"
      config.ssh.username = 'vagrant'
    end
    config.vm.box = "ubuntu/bionic64" # Chọn box bạn muốn sử dụng

    # Khởi tạo máy ảo thứ nhất
    config.vm.define "machine1" do |machine1|
    machine1.vm.network "private_network", ip: "192.168.56.2"
    machine1.vm.provider "virtualbox" do |vb|
          vb.memory = "2048" # 2GB RAM
          vb.cpus = 1       # 1 core CPU
        end

    machine1.vm.provision "shell", inline: <<-SHELL
          adduser airflow
          sudo su - airflow -c $'\
          whoami && \
          mkdir .ssh && \
          echo "ssh-rsa xxxx" > .ssh/authorized_keys && \
          chmod 700 .ssh && \
          chmod 600 .ssh/authorized_keys && \
          file_path=".ssh/authorized_keys" && \
          echo "cat file $file_path after make change" && \
          cat $file_path '
        SHELL
    end
end
```

</details>

# Sync tmux

```
#!/bin/bash

task="task-name"

# Khởi tạo một phiên làm việc mới trong tmux
tmux new-session -d -s $task

# Tạo cửa sổ (tab) 1 và SSH vào server 1
tmux send-keys -t $task:0.0 "ssh machine1" C-m

# Tạo cửa sổ (tab) 2 và SSH vào server 2
tmux split-window -h -t $task:0.0 "ssh machine2"

# Kích hoạt chế độ sync
tmux setw synchronize-panes on

# ctrb b :setw synchronize-panes off

# Kích hoạt chế độ xem (layout even-horizontal) cho các pane
# tmux select-layout even-horizontal

# Attach vào phiên làm việc
tmux attach-session -t $task
```

# Command

- lệnh sync file lên các server. chú ý conf/ -> conf

```
rsync -avPz -e "ssh -p 2395" ./conf/ longpt@192.168.1.1:/home/longpt/conf
```

- chạy các lệnh trên server

```
for node in 10.5.0.157 10.5.0.184; do
	echo $node
	ssh -p 2395 trino@$node "/opt/trino/trino-server/bin/launcher restart"
  ssh -p 2395 longpt@$node "echo $'172.1.1.1 	host1'| sudo tee -a  /etc/hosts"
	echo "done"
done

```

- tìm kiếm và thay thế trong file

```
ssh -p 2395 longpt@192.168.1.1 "sed -i  's/xau_can_thay_the/xau_thay_the/g' /data/file_thay_the"
```

